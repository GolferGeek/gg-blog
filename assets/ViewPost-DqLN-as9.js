import{h as O,j as e,P as q,B as s,E as V,t as l,F as H,I as J,r as c,s as R,D as I,y as U,k as _,u as K,q as Q,v as D,L as E,S as k,G as L,H as B}from"./vendor-C65ctaoV.js";import X from"./editor-C7RkKN59.js";import{b as T,s as p}from"./index-I0dD487A.js";import{f as F}from"./format-BzRktsyD.js";import{D as z}from"./Delete-DyDZc2Gn.js";import{C as Y}from"./ConfirmModal-o5Z1I_1A.js";import"./supabase-Cg6Q1mgr.js";const Z=O(e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit"),ee=O(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send");function te({comment:n,onDelete:t}){const{user:u}=T(),f=u&&u.id===n.user_id,x=n.user_email?n.user_email[0].toUpperCase():"?";return e.jsx(q,{elevation:0,sx:{p:2,mb:2,bgcolor:"background.paper",border:"1px solid",borderColor:"divider"},children:e.jsxs(s,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(V,{sx:{bgcolor:"primary.main"},children:x}),e.jsxs(s,{sx:{flexGrow:1},children:[e.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsxs(s,{children:[e.jsx(l,{variant:"subtitle2",component:"span",children:n.user_email}),e.jsx(l,{variant:"caption",color:"text.secondary",sx:{ml:1},children:F(new Date(n.created_at),"MMM d, yyyy h:mm a")})]}),f&&e.jsx(H,{title:"Delete comment",children:e.jsx(J,{onClick:()=>t(n.id),size:"small",color:"error",children:e.jsx(z,{fontSize:"small"})})})]}),e.jsx(l,{variant:"body2",color:"text.primary",sx:{whiteSpace:"pre-wrap"},children:n.content})]})]})})}function re({postId:n}){const{user:t}=T(),[u,f]=c.useState([]),[x,y]=c.useState(""),[j,b]=c.useState(!0),[P,m]=c.useState(null),[C,M]=c.useState(!1);c.useEffect(()=>{v()},[n]);async function v(){try{m(null);const{data:a,error:i}=await p.from("comments").select("*, profiles(email)").eq("post_id",n).order("created_at",{ascending:!0});if(i)throw i;f(a.map(g=>{var S;return{...g,user_email:(S=g.profiles)==null?void 0:S.email}}))}catch(a){console.error("Error fetching comments:",a),m("Failed to load comments. Please try again.")}finally{b(!1)}}async function A(a){if(a.preventDefault(),!(!t||!x.trim())){M(!0),m(null);try{const{error:i}=await p.from("comments").insert([{content:x.trim(),post_id:n,user_id:t.id}]);if(i)throw i;y(""),await v()}catch(i){console.error("Error adding comment:",i),m("Failed to add comment. Please try again.")}finally{M(!1)}}}async function w(a){try{m(null);const{error:i}=await p.from("comments").delete().eq("id",a);if(i)throw i;f(u.filter(g=>g.id!==a))}catch(i){console.error("Error deleting comment:",i),m("Failed to delete comment. Please try again.")}}return j?e.jsx(s,{sx:{display:"flex",justifyContent:"center",my:4},children:e.jsx(R,{})}):e.jsxs(s,{sx:{mt:4},children:[e.jsxs(l,{variant:"h6",gutterBottom:!0,children:["Comments (",u.length,")"]}),P&&e.jsx(I,{severity:"error",sx:{mb:2},children:P}),t?e.jsxs(q,{component:"form",onSubmit:A,elevation:1,sx:{p:3,mb:4,display:"flex",flexDirection:"column",gap:2,backgroundColor:"background.paper",border:"1px solid",borderColor:"divider",borderRadius:2},children:[e.jsx(U,{multiline:!0,rows:3,value:x,onChange:a=>y(a.target.value),placeholder:"Write a comment...",variant:"outlined",fullWidth:!0,disabled:C,sx:{"& .MuiOutlinedInput-root":{backgroundColor:"background.default","&:hover":{backgroundColor:"background.default","& .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main"}},"&.Mui-focused":{backgroundColor:"background.default","& .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main",borderWidth:2}}}}}),e.jsx(s,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(_,{type:"submit",variant:"contained",disabled:C||!x.trim(),endIcon:e.jsx(ee,{}),sx:{px:3,py:1,borderRadius:2,textTransform:"none",fontWeight:500,"&:hover":{backgroundColor:"primary.dark"}},children:C?"Posting...":"Post Comment"})})]}):e.jsx(I,{severity:"info",sx:{mb:4},children:"Please log in to comment."}),e.jsx(s,{sx:{display:"flex",flexDirection:"column",gap:2},children:u.length>0?u.map(a=>e.jsx(te,{comment:a,onDelete:w},a.id)):e.jsx(l,{color:"text.secondary",align:"center",children:"No comments yet. Be the first to comment!"})})]})}function de(){const{id:n}=K(),[t,u]=c.useState(null),[f,x]=c.useState(!0),[y,j]=c.useState(null),[b,P]=c.useState(null),[m,C]=c.useState([]),M=Q(),{user:v}=T(),[A,w]=c.useState(!1),a=v&&t&&v.id===t.user_id,i=t&&t.arc_id&&t.arc_id!==t.id;c.useEffect(()=>{g()},[n]),c.useEffect(()=>{t&&(t.parent_id&&S(t.parent_id),N(t.id))},[t]);async function g(){try{x(!0),j(null);const{data:r,error:o}=await p.from("posts").select(`
          *,
          tags
        `).eq("id",n).single();if(o)throw o;let d=[];try{if(r.tags){const h=JSON.parse(r.tags);d=Array.isArray(h)?h:[]}}catch(h){console.error("Error parsing tags:",h)}const W={...r,tags:d};u(W)}catch(r){console.error("Error fetching post:",r),j("Failed to load post. Please try again later.")}finally{x(!1)}}async function S(r){try{const{data:o,error:d}=await p.from("posts").select("id, title").eq("id",r).single();if(d)throw d;P(o)}catch(o){console.error("Error fetching parent post:",o)}}async function N(r){try{const{data:o,error:d}=await p.from("posts").select("id, title, created_at").eq("parent_id",r).order("created_at",{ascending:!0});if(d)throw d;const W=o?Array.from(new Map(o.map(h=>[h.id,h])).values()):[];C(W)}catch(o){console.error("Error fetching child posts:",o)}}async function $(){var r;try{const{error:o}=await p.from("posts").delete().eq("id",n);if(o)throw o;const d=((r=t==null?void 0:t.interests)==null?void 0:r[0])||"coder";M(`/${d}`)}catch(o){console.error("Error deleting post:",o),j("Failed to delete post. Please try again."),w(!1)}}const G=()=>{w(!0)};return f?e.jsx(D,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(R,{})}):y?e.jsx(D,{maxWidth:"lg",sx:{mt:4},children:e.jsx(I,{severity:"error",children:y})}):t?e.jsxs(D,{maxWidth:"lg",sx:{mt:4,mb:8},children:[e.jsxs(q,{elevation:3,sx:{p:4},children:[e.jsxs(s,{sx:{mb:4},children:[i&&b&&e.jsx(s,{sx:{mb:2},children:e.jsxs(l,{variant:"body2",color:"text.secondary",children:["Part of thread: ",e.jsx(E,{to:`/post/${b.id}`,style:{color:"inherit",textDecoration:"underline"},children:b.title})]})}),e.jsx(l,{variant:"h3",component:"h1",gutterBottom:!0,children:t.title}),e.jsx(s,{sx:{mb:3,color:"text.secondary"},children:e.jsxs(l,{variant:"body2",children:["Posted on ",F(new Date(t.created_at),"MMMM d, yyyy")]})}),e.jsxs(k,{direction:"row",spacing:4,sx:{mb:3},children:[Array.isArray(t.interests)&&t.interests.length>0&&e.jsxs(s,{children:[e.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Categories"}),e.jsx(k,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:t.interests.map((r,o)=>e.jsx(L,{label:r,color:"secondary",sx:{borderRadius:"4px",fontWeight:500}},o))})]}),Array.isArray(t.tags)&&t.tags.length>0&&e.jsxs(s,{children:[e.jsx(l,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Tags"}),e.jsx(k,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:t.tags.map((r,o)=>e.jsx(L,{label:r,color:"primary",variant:"outlined",sx:{borderRadius:"4px","&:hover":{backgroundColor:"primary.light",color:"white"}}},o))})]})]}),e.jsx(s,{sx:{mt:3,display:"flex",gap:2},children:a&&e.jsxs(e.Fragment,{children:[e.jsx(_,{variant:"contained",color:"primary",component:E,to:"/create",state:{parentPost:t},children:"Create Child Post"}),e.jsx(_,{variant:"outlined",startIcon:e.jsx(Z,{}),component:E,to:`/edit/${t.id}`,children:"Edit"}),e.jsx(_,{variant:"outlined",color:"error",startIcon:e.jsx(z,{}),onClick:G,children:"Delete"})]})})]}),e.jsx(B,{sx:{my:3}}),e.jsx(s,{sx:{"& img":{maxWidth:"100%",height:"auto"}},children:e.jsx(X.Markdown,{source:t.content})}),m.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(B,{sx:{my:4}}),e.jsxs(s,{sx:{mt:2},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:"Continued in:"}),e.jsx(k,{spacing:2,children:m.map(r=>e.jsxs(s,{component:E,to:`/post/${r.id}`,sx:{textDecoration:"none",color:"inherit",display:"flex",justifyContent:"space-between",alignItems:"center",p:2,border:"1px solid",borderColor:"divider",borderRadius:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(l,{variant:"subtitle1",children:r.title}),e.jsx(l,{variant:"body2",color:"text.secondary",children:F(new Date(r.created_at),"MMMM d, yyyy")})]},r.id))})]})]}),e.jsx(B,{sx:{my:4}}),e.jsxs(s,{sx:{mt:4},children:[e.jsx(l,{variant:"h5",gutterBottom:!0,children:"Comments"}),e.jsx(re,{postId:t.id})]})]}),e.jsx(Y,{open:A,onClose:()=>w(!1),onConfirm:$,title:"Delete Post",content:"Are you sure you want to delete this post? This action cannot be undone."})]}):e.jsx(D,{maxWidth:"lg",sx:{mt:4},children:e.jsx(I,{severity:"info",children:"Post not found"})})}export{de as default};
//# sourceMappingURL=ViewPost-DqLN-as9.js.map
